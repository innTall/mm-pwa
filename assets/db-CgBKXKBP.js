const h=(e,t)=>t.some(n=>e instanceof n);let l,B;function C(){return l||(l=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function O(){return B||(B=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const m=new WeakMap,y=new WeakMap,f=new WeakMap;function p(e){const t=new Promise((n,o)=>{const s=()=>{e.removeEventListener("success",i),e.removeEventListener("error",r)},i=()=>{n(d(e.result)),s()},r=()=>{o(e.error),s()};e.addEventListener("success",i),e.addEventListener("error",r)});return f.set(t,e),t}function x(e){if(m.has(e))return;const t=new Promise((n,o)=>{const s=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",r),e.removeEventListener("abort",r)},i=()=>{n(),s()},r=()=>{o(e.error||new DOMException("AbortError","AbortError")),s()};e.addEventListener("complete",i),e.addEventListener("error",r),e.addEventListener("abort",r)});m.set(e,t)}let D={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return m.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return d(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function P(e){D=e(D)}function N(e){return O().includes(e)?function(...t){return e.apply(w(this),t),d(this.request)}:function(...t){return d(e.apply(w(this),t))}}function A(e){return typeof e=="function"?N(e):(e instanceof IDBTransaction&&x(e),h(e,C())?new Proxy(e,D):e)}function d(e){if(e instanceof IDBRequest)return p(e);if(y.has(e))return y.get(e);const t=A(e);return t!==e&&(y.set(e,t),f.set(t,e)),t}const w=e=>f.get(e);function j(e,t,{blocked:n,upgrade:o,blocking:s,terminated:i}={}){const r=indexedDB.open(e,t),u=d(r);return o&&r.addEventListener("upgradeneeded",a=>{o(d(r.result),a.oldVersion,a.newVersion,d(r.transaction),a)}),n&&r.addEventListener("blocked",a=>n(a.oldVersion,a.newVersion,a)),u.then(a=>{i&&a.addEventListener("close",()=>i()),s&&a.addEventListener("versionchange",c=>s(c.oldVersion,c.newVersion,c))}).catch(()=>{}),u}const T=["get","getKey","getAll","getAllKeys","count"],V=["put","add","delete","clear"],b=new Map;function g(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(b.get(t))return b.get(t);const n=t.replace(/FromIndex$/,""),o=t!==n,s=V.includes(n);if(!(n in(o?IDBIndex:IDBObjectStore).prototype)||!(s||T.includes(n)))return;const i=async function(r,...u){const a=this.transaction(r,s?"readwrite":"readonly");let c=a.store;return o&&(c=c.index(u.shift())),(await Promise.all([c[n](...u),s&&a.done]))[0]};return b.set(t,i),i}P(e=>({...e,get:(t,n,o)=>g(t,n)||e.get(t,n,o),has:(t,n)=>!!g(t,n)||e.has(t,n)}));const v=["continue","continuePrimaryKey","advance"],E={},I=new WeakMap,M=new WeakMap,W={get(e,t){if(!v.includes(t))return e[t];let n=E[t];return n||(n=E[t]=function(...o){I.set(this,M.get(this)[t](...o))}),n}};async function*k(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const n=new Proxy(t,W);for(M.set(n,t),f.set(n,w(t));t;)yield n,t=await(I.get(n)||t.continue()),I.delete(n)}function S(e,t){return t===Symbol.asyncIterator&&h(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&h(e,[IDBIndex,IDBObjectStore])}P(e=>({...e,get(t,n,o){return S(t,n)?k:e.get(t,n,o)},has(t,n){return S(t,n)||e.has(t,n)}}));const F=[{dbName:"orderDatabase",storeName:"orders"},{dbName:"bybitSpotDatabase",storeName:"bybitSpot"},{dbName:"binanceSpotDatabase",storeName:"binanceSpot"}],L=async(e,t)=>await j(e,1,{upgrade(n){n.objectStoreNames.contains(t)||n.createObjectStore(t,{keyPath:"id",autoIncrement:!0})}}),K=async e=>{for(const{dbName:t,storeName:n}of F){const s=(await L(t,n)).transaction(n,"readwrite");await s.store.clear();for(const i of e){const r=JSON.parse(JSON.stringify(i));await s.store.add(r)}await s.done}},R=async(e,t)=>await(await L(e,t)).getAll(t);export{R as f,K as s};
